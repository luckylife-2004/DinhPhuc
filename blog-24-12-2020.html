<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Louis Hoang</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="assets/img/logo.png" rel="icon">
    <link href="assets/img/logo.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
          rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="assets/css/icomoon.css" rel="stylesheet">
</head>

<body>

<!-- ======= Mobile nav toggle button ======= -->
<i class="bi bi-list mobile-nav-toggle d-xl-none"></i>

<!-- ======= Header ======= -->
<header id="header">
    <div class="d-flex flex-column">

        <div class="profile">
            <img src="assets/img/profile-img.jpg" alt="" class="img-fluid rounded-circle">
            <h1 class="text-light"><a href="index.html">Louis Hoang</a></h1>
            <div class="social-links mt-3 text-center">
                <!--                <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>-->
                <!--                <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>-->
                <!--                <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>-->
                <!--                <a href="#" class="google-plus"><i class="bx bxl-skype"></i></a>-->
                <a href="https://www.linkedin.com/in/louis-hoang/" class="linkedin"><i class="bx bxl-linkedin"></i></a>
                <a href="https://github.com/louis-hoang21" class="linkedin"><i class="bx bxl-github"></i></a>
            </div>
        </div>

        <nav id="navbar" class="nav-menu navbar">
            <ul>
                <li><a href="index.html" class="nav-link scrollto active"><i class="bx bx-home"></i> <span>Home</span></a></li>
                <li><a href="index.html#about" class="nav-link scrollto"><i class="bx bx-user"></i> <span>About</span></a></li>
                <li><a href="index.html#resume" class="nav-link scrollto"><i class="bx bx-file-blank"></i> <span>Resume</span></a></li>
                <li><a href="index.html#blogs" class="nav-link scrollto"><i class="bx bx-book-content"></i> <span>Blogs</span></a></li>
            </ul>
        </nav>
    </div>
</header>

<main id="main">

    <!-- ======= Breadcrumbs ======= -->
    <section id="breadcrumbs" class="breadcrumbs">
        <div class="container">

            <div class="d-flex justify-content-between align-items-center">
                <h2>Sử dụng google drive api trong Laravel</h2>
                <ol>
                    <li><a href="index.html">Home</a></li>
                    <li>Sử dụng google drive api trong Laravel</li>
                </ol>
            </div>

        </div>
    </section><!-- End Breadcrumbs -->

    <!-- ======= Portfolio Details Section ======= -->
    <section id="portfolio-details" class="portfolio-details">
        <div class="container">
            <div class="portfolio-info">
                <div>
                    <h3>I. Lời mở đầu</h3>
                    <div>
                        Chào mọi người, vừa rồi mình được giao một task liên quan đến việc kéo nội dung trong file doc và tải các ảnh trên google drive rồi upload lên database của hệ thống. Nên hôm nay mình có tổng hợp lại một số thứ mình tìm hiểu được để chia sẻ với anh em, kiến thức còn hạn hẹp chưa đủ sâu nên có gì mọi người cùng góp ý để mình hoàn thiện bài viết tốt nhất nhé. Trong bài viết này mình sẽ hook vào google drive api để get được thông tin, export được từ file doc => file html rồi insert vào database, tải ảnh từ google drive rồi đưa vào database. Không dài dòng mình bắt đầu luôn.
                    </div>
                </div>
                <br>
                <div>
                    <h3>II. Thực hiện</h3>
                    <div>
                        <h4>1. Create a new project</h4>
                        <div>
                            <p>Mình xin phép bỏ qua bước cài đặt project laravel vì có rất nhiều bài nói về bước này rồi. Mình sẽ để link cài đặt ở phía duới</p>
                            <a href="https://laravel.com/docs/master/installation">https://laravel.com/docs/master/installation</a>
                        </div>
                    </div>
                    <div>
                        <h4>
                            2. Create Google Drive Application
                        </h4>
                        <div>
                            <p>Để lưu trữ file trên Google Drive, bạn cần lấy đủ 4 thông tin bên trên. Để có thông tin chi tiết về cách lấy API ID, secret và refresh token, bạn tham khảo hướng dẫn sau:</p>
                            <ul>
                                <li><a href="https://github.com/ivanvermeyen/laravel-google-drive-demo/blob/master/README/1-getting-your-dlient-id-and-secret.md" target="_blank"></a>Lấy Client ID and Secret</li>
                            </ul>
                            <p>
                                Add user test vào project, vì khi mới tạo project thì đang ở trạng thái là test. Mục này rất quan trọng nếu không add user test sẽ không thể connect được api. Sau đó làm tiếp theo các bước:
                            </p>
                            <div class="text-center">
                                <img src="assets/img/blogs/img-blog-2.png" alt="">
                            </div>
                            <ul>
                                <li>
                                    <a href="https://github.com/ivanvermeyen/laravel-google-drive-demo/blob/master/README/2-getting-your-refresh-token.md">Lấy Refresh Token</a>
                                </li>
                                <li>
                                    <a href="https://github.com/ivanvermeyen/laravel-google-drive-demo/blob/master/README/3-getting-your-root-folder-id.md">Lấy ID thư mục lưu trữ</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <h4>3. Configure Google Service</h4>
                        <div>
                            <p>Mình sử dụng package <a href="https://github.com/nao-pon/flysystem-google-drive">Flysystem Adapter for Google Drive </a></p>
                            <p>Cài đặt package cho Google Drive API V3 <b>composer require nao-pon/flysystem-google-drive:~1.1</b> Mình khuyên các bạn nên sử dụng API V3, vì V3 đã có nhiều thay đổi tốt hơn V2 đồng thời nhiều hàm cũng được loại bỏ bớt các parameter không quá cần thiết. Trên doc của google V3 thì chưa có Samples cho PHP nhưng vì cơ bản V2 và V3 PHP cũng không có gì thay đổi nhiều nên bạn có thể hoàn toàn sử dụng và tham khảo lại doc PHP của V2. Một điều nữa để khuyên bạn nên dùng V3 là ở trong package vừa cài đặt trên tác giả cũng ghi rõ *For Google Drive API V2 "Deprecated" .</p>
                            <p>Sau khi cài đặt package xong, chúng ta cần: Thêm <b>GoogleDriveServiceProvider::class</b> vào <b>providers</b> trong file <b>config/app.php</b></p>
                            <pre class="language-none" data-filename="">
                                <code class="language-none">
    'providers' =&gt; [
        // ...
        App\Providers\GoogleDriveServiceProvider::class,
        // ...
    ],
                                </code>
                            </pre>
                            <p>Thêm google disk vào <b>config/filesystems.php</b></p>
                            <pre class="language-none" data-filename="">
                                <code class="language-none">
        'google' =&gt; [
            'driver' =&gt; 'google',
            'clientId' =&gt; env('GOOGLE_DRIVE_CLIENT_ID'),
            'clientSecret' =&gt; env('GOOGLE_DRIVE_CLIENT_SECRET'),
            'refreshToken' =&gt; env('GOOGLE_DRIVE_REFRESH_TOKEN'),
            'folderId' =&gt; env('GOOGLE_DRIVE_FOLDER_ID'),
        ],
                                </code>
                            </pre>
                            <p>Cập nhật file .env Thêm ClientID, ClientSecret, RefreshToken mà bạn vừa thực hiện các bước ở trên vào file env</p>
                            <pre class="language-none" data-filename="">
                                <code class="language-none">
    FILESYSTEM_CLOUD=google
    GOOGLE_DRIVE_CLIENT_ID=XXXXXXXX-XXXXXXXXXXXXXXXXXXXXXXXXXXX.apps.googleusercontent.com
    GOOGLE_DRIVE_CLIENT_SECRET=XXXX_ByGjXXXXX
    GOOGLE_DRIVE_REFRESH_TOKEN=XXXXXXXXXXXXXXXXXXXXXXXXXX-XXXXXXXXXXXXXXXXXXXXXXXXXXT1J1S5-Bv51KAUWR49M6jKmOXXXXXXXXXXX
                                </code>
                            </pre>
                        </div>
                    </div>
                    <div>
                        <h4>4. Create GoogleServiceProvider</h4>
                        <div>
                            <p>Bạn tạo file GoogleServiceProvider trong thư mục Providers</p>
                            <pre class="language-none" data-filename="">
                                <code class="language-none">
    &lt;?php

    namespace App\Providers;

    use Illuminate\Support\ServiceProvider;

    class GoogleDriveServiceProvider extends ServiceProvider
    {
        /**
         * Bootstrap the application services.
         *
         * @return void
         */
        public function boot()
        {
            \Storage::extend('google', function ($app, $config) {
                $client = new \Google_Client();
                $client-&gt;setClientId($config['clientId']);
                $client-&gt;setClientSecret($config['clientSecret']);
                $client-&gt;refreshToken($config['refreshToken']);

                return new \Google_Service_Drive($client);
            });
        }

        /**
         * Register the application services.
         *
         * @return void
         */
        public function register()
        {
            //
        }
    }
                                </code>
                            </pre>
                            <p>Giờ chúng ta code thôi !!!</p>
                        </div>
                    </div>
                    <div>
                        <h4>5. Get files</h4>
                        <div>
                            <p>Để get files thì chúng ta cần có <b>fileId</b> của file trên google drive. Việc get files này thì có thể get được tất cả các loại file từ định dạng image, doc, excel.</p>
                            <pre class="language-none" data-filename="">
                                <code class="language-none">
            $driveService = Storage::disk('google');
            $file = $driveService-&gt;files-&gt;get($fileId);
                                </code>
                            </pre>
                            <p>Kết quả trả về là collection:</p>
                            <div class="text-center">
                                <img style="-webkit-user-select: none;margin: auto;cursor: zoom-in;background-color: hsl(0, 0%, 90%);transition: background-color 300ms;" src="https://images.viblo.asia/2f22c6e3-3b4a-433a-9833-8788a98545b8.png" width="382" height="632">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4>6. Get list files</h4>
                        <div>
                            <p>Để get list files từ một folder cụ thể. <b>$folderId</b> sẽ là ID của folder chứa các files mà bạn muốn lấy về.</p>
                            <pre class="language-none" data-filename="">
                                <code class="language-none">
        $driveService = Storage::disk('google');
        $query = "'" . $folderId . "' in parents and trashed=false";

        $optParams = [
            'fields' =&gt; 'nextPageToken, files(id, name)',
            'q' =&gt; $query
        ];

        $results = $driveService-&gt;files-&gt;listFiles($optParams);
                                </code>
                            </pre>
                            <p>Kết quả trả về:</p>
                            <div class="text-center">
                                <img data-pil-src="https://images.viblo.asia/a45e98ad-d74e-483f-9788-01ecce3e85ed.png" class="pil-original-img article-img medium-zoom-image" width="458" height="312" data-pil-srcset="https://images.viblo.asia/retina/a45e98ad-d74e-483f-9788-01ecce3e85ed.png 2x" data-zoom-src="https://images.viblo.asia/full/a45e98ad-d74e-483f-9788-01ecce3e85ed.png" src="https://images.viblo.asia/a45e98ad-d74e-483f-9788-01ecce3e85ed.png" srcset="https://images.viblo.asia/retina/a45e98ad-d74e-483f-9788-01ecce3e85ed.png 2x">
                            </div>
                            <p>Nếu bạn muốn kết quả trả về là một list file luôn thì sử dụng <b>$results->getFiles()</b>. Trong kết quả trả về có đầy đủ thông tin của file.</p>
                        </div>
                    </div>
                    <div>
                        <h4>7. Download files</h4>
                        <div>
                            <p>Để download file mình vẫn sử dụng method <b>files->get()</b> nhưng thêm một parameter <b>array('alt' => 'media').alt=media</b> cho máy chủ biết rằng nội dung đang được yêu cầu tải xuống. Sau đó sử dụng <b>getBody()->getContents()</b> để lấy được file. Để tài xuống file từ api thì bạn cần ít nhất quyền truy cập đọc vào file ý. Tham khảo thêm về
                                <a href="https://developers.google.com/drive/api/v3/manage-downloads">downloadfiles</a> . Bạn có thể download được cả file image, doc, excel... nhé.</p>
                            <pre class="language-none" data-filename="">
                                <code class="language-none">
            $file = $driveService-&gt;files-&gt;get($file-&gt;id, array('alt' =&gt; 'media'));
            $file =  $file-&gt;getBody()-&gt;getContents();

            // save file to Storage
            Storage::put($file);
                                </code>
                            </pre>
                        </div>
                    </div>
                    <div>
                        <h4>8. Export files</h4>
                        <div>
                            <p>Để export file bạn cần lưu ý chỉ export được những file định dạng docs, excel. Với những file là docx sẽ không thể
                                <a href="https://developers.google.com/drive/api/v3/ref-export-formats">export</a> được. Bạn có thể tham khảo các định dạng được export. Đoạn code dưới của mình là export file đọc sang dạng html.</p>
                            <pre class="language-none" data-filename="">
                                <code class="language-none">
        $driveService = Storage::disk('google');
        $nameFile = $driveService-&gt;files-&gt;get($fileId)-&gt;name;
        $file = $driveService-&gt;files-&gt;export($fileId, 'text/html', array(
            'alt' =&gt; 'media'));
        $content = $file-&gt;getBody()-&gt;getContents();
        $path = 'files/' . $nameFile . '.html';
        Storage::put($path, $content);
                                </code>
                            </pre>
                            <p>Đến đoạn này là bạn đã có 1 file html có thể cầm file insert vào database rồi.</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h3>III. Kết luận</h3>
                    <div>
                        <p>Trên đây, mình đã giới thiệu với các bạn 1 vài thao tác cơ bản để lưu trữ file với Google Drive như: get file, download file, lấy danh sách file, export file. Để có thể tìm hiểu về các thao tác khác như: tạo thư mục, tạo file trong thư mục, đổi tên thư mục, xóa thư mục, ... bạn có thể tham khảo thêm
                            <a href="https://developers.google.com/drive/api/v3/about-sdk">tại đây</a>.</p>
                        <p>Hy vọng, bài viết này của mình sẽ giúp ích cho các bạn xử lý file lưu trữ trên Google Drive. Bài viết này còn nhiều thiếu xót mong các bạn góp ý để mình hoàn thiện thêm</p>
                        <p>Cám ơn các bạn đã đọc bài viết.</p>
                    </div>
                </div>
                <div>
                    <h3>IV. Tài liệu tham khảo</h3>
                    <div>
                        <ul>
                            <li><a href="https://github.com/nao-pon/flysystem-google-drive">https://github.com/nao-pon/flysystem-google-drive</a></li>
                            <li><a href="https://viblo.asia/p/luu-tru-file-voi-google-drive-trong-laravel-Qbq5QgXmZD8">https://viblo.asia/p/luu-tru-file-voi-google-drive-trong-laravel-Qbq5QgXmZD8</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section><!-- End Portfolio Details Section -->

</main><!-- End #main -->

<!-- ======= Footer ======= -->
<footer id="footer">
    <div class="container">
        <div class="copyright">
            &copy; Copyright <strong><span>Louis Hoang</span></strong><br>
            <span id="copyright-years"></span>
        </div>
    </div>
</footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>

<!-- Vendor JS Files -->
<script src="assets/vendor/purecounter/purecounter.js"></script>
<script src="assets/vendor/aos/aos.js"></script>
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
<script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
<script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
<script src="assets/vendor/typed.js/typed.min.js"></script>
<script src="assets/vendor/waypoints/noframework.waypoints.js"></script>
<script src="assets/vendor/php-email-form/validate.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Template Main JS File -->
<script src="assets/js/main.js"></script>

</body>

</html>